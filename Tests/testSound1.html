<!DOCTYPE html>
<html>
<head>
    <title>Scale Sound Tests</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            margin: 5px;
            font-size: large;
        }
     
        input {
            font-size: initial;
        }
        

        .E3D_fullscreenContainer {
            position:fixed;
            top:0px;
            bottom:0px;
            right:0px;
            left:0px;
        }

        .E3D_flexVertical {
            display: flex;
            flex-direction: column;
        }
        .E3D_flexHorizontal {
            display: flex;
            flex-direction: row;
        }
        .E3D_flexContent {
            overflow: hidden;
            flex: 1 1 auto;
        }
        .E3D_flexVerticalContentFixed {
            width: 100%;
            height: fit-content;
        }
        .E3D_flexHorizontalContentFixed {
            width: fit-content;
            height: 100%;
        }

        .E3D_fakeButton {
            cursor: pointer;
            background-color: #d0d0d0;   
            padding-right: 0.2em;
            padding-left: 0.2em;   
            user-select: none;   
            box-shadow: 0.1em 0.1em black;      
            border-radius: 0.2em; 
            margin: 0.1em 0.2em 0.2em 0.2em;
            display: inline-block;
        }
        .E3D_fakeButton:hover {
            background-color: #a0a0a0;
        }
   
        #freq {
            height : 30px;
            display: block;
        }
        .noteDiv {
            background-color: white;
            width : 250px;
            height : 30px;

            cursor: pointer;
            border: 2px solid black;
            border-collapse: collapse;
            font-family: 'Courier New', Courier, monospace;
        }
        .noteDiv:hover {
            background-color: #a0a0a0;
        }

        .scale {
            margin: 5px;
            display: inline-block;
            border: 1px solid black;
        }

        .halfDiv {
            background-color: white;
            width : 123px;
            height : 30px;
            display: table-cell;
            cursor: pointer;
            border: 2px solid black;
            border-collapse: collapse;
            font-family: 'Courier New', Courier, monospace;
        }
        .halfDiv:hover {
            background-color: #a0a0a0;
        }

        .playingNote {
            background-color: #B0FFB0;
        }
        .playingNote:hover {
            background-color: #80FF80;
        }
        .selectedNote {
            background-color: #c0c0ff;
        }
        .selectedNote:hover {
            background-color: #8080FF;
        }
        .refNote {
            border: 2px solid blue;
        }
        .calcNote {
            border: 2px solid red;
        }


    </style>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function() { 

            function getElem(id) {
                var elem = document.getElementById(id);
                if (elem) return elem;
                return false;
            }

            function onClick(elemOrID, callback) {
                if (typeof(elemOrID) == "string") elemOrID = getElem(elemOrID);
                if (elemOrID) elemOrID.addEventListener("click", callback);
            }

            function onEvent(elemOrID, event, callback) {
                if (typeof(elemOrID) == "string") elemOrID = getElem(elemOrID);
                if (elemOrID) elemOrID.addEventListener(event, callback);
            }

            onClick("startButton", enable);
            var freq = getElem("freq");
            var freq_log = getElem("freq_log");
            var freq_pyth = getElem("freq_pyth");
            var freq_pyth2 = getElem("freq_pyth2");

            var notes = document.querySelectorAll(".noteDiv, .halfDiv");
            notes.forEach((e) => onEvent(e, "mousedown", playNote));
            notes.forEach((e) => onEvent(e, "mouseup", stopNote));
            notes.forEach((e) => onEvent(e, "mouseleave", stopNote));

            var audioCtx;
            var oscillatorNodes = []; //1, oscillatorNodes2, oscillatorNodes3;
            var gainNodes = [];// , gainNodes2, gainNodes3;

            class playback {
                constructor (offset, text, freq, type) {
                    this.offset = offset; // note offset in dom
                    this.text = text; // note text content
                    this.freq = freq; // calculated note frequency
                    this.type = type; // note tuning scale type
                }
            }
            var currentScale = "";
            var currentNote = 0;
            var alt_num = getElem("alt_num");
            if (window.localStorage) {
                var v = window.localStorage.getItem("m1.alt");
                if (v != undefined) {
                    alt_num.value = v;
                }
            }
            var alt_interval = setInterval(alternateNote, alt_num.value);
            alt_num.addEventListener("input", function (event) {
                clearInterval(alt_interval);
                alt_interval = setInterval(alternateNote, this.value);
                if (window.localStorage) window.localStorage.setItem("m1.alt", this.value);
            });
            var playbackList = [];

            // volume slider
            var volSlider = getElem("volSlider");
            if (window.localStorage) {
                var v = window.localStorage.getItem("m1.vol");
                if (v != undefined) {
                    volSlider.value = v;
                }
            }
            volSlider.addEventListener("input", function (event) { 
                for (var i = 0; i < playbackList.length; ++i) gainNodes[i].gain.value = this.value;
                if (window.localStorage) window.localStorage.setItem("m1.vol", this.value);
            });


            function enable() {
                // create web audio api context
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                // create Gain and Oscillator nodes
                for (var i = 0; i < 3; ++i) {
                    gainNodes.push(audioCtx.createGain());
                    gainNodes[i].connect(audioCtx.destination);
                    gainNodes[i].gain.value = 0;

                    oscillatorNodes.push(audioCtx.createOscillator());
                    oscillatorNodes[i].connect(gainNodes[i]);
                    oscillatorNodes[i].start();
                };
              //  audioCtx.suspend();

            }

            const log_baseFactor = Math.pow(2.0, 1.0/12.0);
            const log_startOffset = 40;
            const log_unison = 49;

            const pyth_unison = 2;
            const pyth_ratio = [ 1024/512, 256/243, 128/81, 32/27, 16/9, 4/3, 1/1, 3/2, 9/8, 27/16, 81/64, 243/128, 729/512].sort();

            const pyth2_ratio = [    1/1, //c
                                    256/243, 2187/2048,
                                    65536/59049, //d
                                    32/27, 19683/16384,
                                    81/64, //e
                                    177147/131072, //f ?
                                    1024/729, 729/512,
                                    262144/177147,//g
                                    128/81, 6561/4096,
                                    27/16, //a
                                    16/9, 59049/32768,
                                    243/128, //b
                                    2/1 //c
                                ];
            const pyth2_unison = 3;

            function playNote(e) {
                if (!audioCtx) return;
                
                // calc and play note
                var type = this.getAttribute("data-type");            
                var offset = this.getAttribute("data-offset");

                var newFreq = -1;

                if (type == "log") {
                    var baseFreq = Number(freq_log.value);                    
                    if ((baseFreq == NaN) || (baseFreq <= 0)) baseFreq = 440;

                    if (offset == "X") {
                        newFreq = baseFreq * Math.pow(log_baseFactor, (log_startOffset - log_unison)) * 2.0;

                    } else if (offset == "D") {
                        newFreq = baseFreq * Math.pow(log_baseFactor, (12 + log_startOffset - log_unison)) / 2.0;

                    } else {
                        var offset = Number(offset);
                        newFreq = baseFreq * Math.pow(log_baseFactor, (offset + log_startOffset - log_unison));

                    }
                } else if (type == "pyth") {
                    var baseFreq = Number(freq_pyth.value);                    
                    if ((baseFreq == NaN) || (baseFreq <= 0)) baseFreq = 288;
                    baseFreq = baseFreq / pyth_ratio[pyth_unison];

                    if (offset == "X") {
                        newFreq = baseFreq * 2.0;

                    } else if (offset == "D") {
                        newFreq = baseFreq * pyth_ratio[12] / 2.0;
                    } else {
                        var offset = Number(offset);                        
                        newFreq = baseFreq * pyth_ratio[offset];
                    }
                } else if (type == "pyth2") {
                    var baseFreq = Number(freq_pyth2.value);                    
                    if ((baseFreq == NaN) || (baseFreq <= 0)) baseFreq = 288;
                    baseFreq = baseFreq / pyth2_ratio[pyth2_unison];

                    if (offset == "X") {
                        newFreq = baseFreq * 2.0;
                    } else if (offset == "D") {
                        newFreq = baseFreq * pyth2_ratio[17] / 2.0;
                    } else {
                        var offset = Number(offset);                        
                        newFreq = baseFreq * pyth2_ratio[offset];
                    }
                }


                if (newFreq > 0) {

                    var playType = document.querySelector('input[name="play"]:checked').value;

                 /*   if (type != currentScale) { // new scale, erease all
                        for (var i = 0; i < playbackList.length; ++i) {
                            var elem = document.querySelector('div[data-type="'+ playbackList[i].type +'"][data-offset="' + playbackList[i].offset+'"]');
                            elem.classList.remove("greenNote");
                        }
                        playbackList = [];

                    } else while (playbackList.length > 2) {// clamp to 3 max
                        var oldPB = playbackList.pop(); 
                        var elem = document.querySelector('div[data-type="'+ oldPB.type + '"][data-offset="' + oldPB.offset+'"]');
                        elem.classList.remove("greenNote");
                    }
                    */

                    

                    if (playType == "single") {      
            
                        removeAllNotesStyle();

                        // update state and UI
                        currentScale = type;
                        freq.innerText = this.innerText + " " + newFreq.toFixed(4);
                        playbackList = [new playback(offset, freq.innerText, newFreq, type)];
                        addNoteStyle(type, offset);

                        // update sound generator
                        oscillatorNodes[0].frequency.value = newFreq;
                        gainNodes[0].gain.value = volSlider.value;
                        gainNodes[1].gain.value = 0;
                        gainNodes[2].gain.value = 0;

                    } else if (playType == "alternate") {
                        var ni = noteInList(type, offset);
                        if (ni > -1) {
                            // if in list remove from list
                            var oldPB = playbackList.splice(ni, 1)[0];
                            removeNoteStyle(oldPB.type, oldPB.offset);
                            if (playbackList.length == 0) gainNodes[0].gain.value = 0;
                        } else {
                            while (playbackList.length > 2) {
                                // else remove last if more than 2
                                var oldPB = playbackList.pop();
                                removeNoteStyle(oldPB.type, oldPB.offset);
                            }
                            //      add to list
                            currentScale = type;
                            var newText = this.innerText + " " + newFreq.toFixed(4);
                            playbackList.push(new playback(offset, newText, newFreq, type));
                            addNoteStyle(type, offset);
                        }
                    } else if (playType == "chord") {

                        // if different type remove all
                        // if in list remove from list
                        // else remove last if more than 2
                        //      add to list
                    }

                } // new Freq




/*

                    for (var i = 0; i < 3; ++i) {
                        if (i+1 <= playbackList.length) {
                            oscillatorNodes[i].frequency.value = playbackList[i].freq;
                            gainNodes[i].gain.value = volSlider.value;
                            freq.innerText += playbackList[i].text + ", ";

                            var elem = document.querySelector('div[data-type="'+ playbackList[i].type + '"][data-offset="' + playbackList[i].offset+'"]');
                            if (elem) elem.classList.add("greenNote");
                        } else {
                            gainNodes[i].gain.value = 0;
                        }
                    }
*/
             
                e.preventDefault();
            }

            

            function stopNote() {
                if (!audioCtx) return;
                var playType = document.querySelector('input[name="play"]:checked').value;
                if (playType == "single") for (var i = 0; i < 3; ++i) gainNodes[i].gain.value = 0;
            }

            function alternateNote() {
                var playType = document.querySelector('input[name="play"]:checked').value;
                if (playType == "alternate") {
                    currentNote++;
                    freq.innerText = "";
                    if (currentNote >= playbackList.length) currentNote = 0;
                    for (var i = 0; i < playbackList.length; ++i) {
                        if (i == currentNote) {

                            freq.innerText += "[X]" + playbackList[i].text + " " + playbackList[i].freq.toFixed(4) + ", ";

                            oscillatorNodes[0].frequency.value = playbackList[i].freq;
                            gainNodes[0].gain.value = volSlider.value;
                            gainNodes[1].gain.value = 0;
                            gainNodes[2].gain.value = 0;

                        } else {
                            freq.innerText += "[ ]" + playbackList[i].text + " " + playbackList[i].freq.toFixed(4) + ", ";
                        }
                    }

                }
            }

            function getElementFromTypeAndOffset(type, offset){
                return document.querySelector('div[data-type="'+type+'"][data-offset="'+offset+'"]');
            }

            function removeAllNotesStyle() {
                for (var i = 0; i < playbackList.length; ++i) removeNoteStyle(playbackList[i].type, playbackList[i].offset);
            }

            function removeNoteStyle(type, offset) {
                var elem = getElementFromTypeAndOffset(type, offset);
                if (elem) elem.classList.remove("greenNote");
            }

            function addNoteStyle(type, offset) {
                var elem = getElementFromTypeAndOffset(type, offset);
                if (elem) elem.classList.add("greenNote");
            }

            function noteInList(type, offset) {
                for (var i = 0; i < playbackList.length; ++i) if ((playbackList[i].type == type) && (playbackList[i].offset == offset)) return i;
                return -1;
            }


        } );
    </script>
</head>

<body>
<div id="startButton" class="E3D_fakeButton">Enable</div><br />
<input id="volSlider" type="range" min="0.0" max="1.0" value="0.5" step="0.01" />Volume<br />
<input value="amp" name="eq" type="radio" checked="true"/>Equal Amplitude<br/>
<input value="energy" name="eq" type="radio" />Equal Energy<br/>
<input value="single" name="play" type="radio" checked="true"/>Play 1 note<br/>
<input value="alternate" name="play" type="radio" />Play notes alternatively every <input id="alt_num" type="number" min="10" max="10000" value="250" />ms<br/>
<input value="chord" name="play" type="radio" />Play notes togheter<br/>

<hr />
<span id="freq">440</span>
<hr />
<div id="logScale" class="scale">
    12-TET (western, tempered)<br>
    <sup>12</sup>√2<sup>n</sup><br>
    A=<input id="freq_log" type="number" min="1" max="22000" value="440" />(440)<br />
    <!--iv data-type="log" data-offset="D" class="noteDiv calcNote">12/12 /2 (C4 / 2)</div-->
    <div data-type="log" data-offset="0" class="noteDiv">&nbsp;0/12 C3 do</div>
    <div data-type="log" data-offset="1" class="noteDiv">&nbsp;1/12 C&#9839;</div>
    <div data-type="log" data-offset="2" class="noteDiv">&nbsp;2/12 D ré</div>
    <div data-type="log" data-offset="3" class="noteDiv">&nbsp;3/12 D&#9839;</div>
    <div data-type="log" data-offset="4" class="noteDiv">&nbsp;4/12 E mi</div>
    <div data-type="log" data-offset="5" class="noteDiv">&nbsp;5/12 F fa</div>
    <div data-type="log" data-offset="6" class="noteDiv">&nbsp;6/12 F&#9839;</div>
    <div data-type="log" data-offset="7" class="noteDiv">&nbsp;7/12 G sol</div>
    <div data-type="log" data-offset="8" class="noteDiv">&nbsp;8/12 G&#9839;</div>
    <div data-type="log" data-offset="9" class="noteDiv refNote">&nbsp;9/12 A la</div>
    <div data-type="log" data-offset="10" class="noteDiv">10/12 A&#9839;</div>
    <div data-type="log" data-offset="11" class="noteDiv">11/12 B si</div>
    <div data-type="log" data-offset="12" class="noteDiv">12/12 C4 do</div>
    <!--div data-type="log" data-offset="X" class="noteDiv calcNote">&nbsp;0/12 X2 (C4)</div-->
</div>

<div id="pythScale" class="scale">
    Pythagorian 12 Tones Perfect 5th<br>
    3<sup>n</sup>/2<sup>n</sup>, 2<sup>n</sup>/3<sup>n</sup><br>
    D=<input id="freq_pyth" type="number" min="1" max="22000" value="293" />(288)<br />
    <!--div data-type="pyth" data-offset="D" class="noteDiv calcNote">&nbsp;12/12 /2 (C4 / 2)</div-->
    <div data-type="pyth" data-offset="0" class="noteDiv">&nbsp;0/12 C3 do</div>
    <div data-type="pyth" data-offset="1" class="noteDiv">&nbsp;1/12 C&#9839;</div>
    <div data-type="pyth" data-offset="2" class="noteDiv refNote">&nbsp;2/12 D ré</div>
    <div data-type="pyth" data-offset="3" class="noteDiv">&nbsp;3/12 E&#9837;</div>
    <div data-type="pyth" data-offset="4" class="noteDiv">&nbsp;4/12 E mi</div>
    <div data-type="pyth" data-offset="5" class="noteDiv">&nbsp;5/12 F fa</div>
    <div data-type="pyth" data-offset="6" class="noteDiv">&nbsp;6/12 F&#9839;</div>
    <div data-type="pyth" data-offset="7" class="noteDiv">&nbsp;7/12 G sol</div>
    <div data-type="pyth" data-offset="8" class="noteDiv">&nbsp;8/12 G&#9839;</div>
    <div data-type="pyth" data-offset="9" class="noteDiv">&nbsp;9/12 A la</div>
    <div data-type="pyth" data-offset="10" class="noteDiv">10/12 B&#9837;</div>
    <div data-type="pyth" data-offset="11" class="noteDiv">11/12 B si</div>
    <div data-type="pyth" data-offset="12" class="noteDiv calcNote">12/12 C4 do</div>
    <!--div data-type="pyth" data-offset="X" class="noteDiv calcNote">&nbsp;0/12 X 2</div-->

</div>
<div id="pyth2Scale" class="scale">
    Pythagorian Full<br>
    3<sup>n</sup>/2<sup>n</sup>, 2<sup>n</sup>/3<sup>n</sup><br>
    D=<input id="freq_pyth2" type="number" min="1" max="22000" value="288" /><br />
    <!--div data-type="pyth2" data-offset="D" class="noteDiv calcNote">&nbsp;12/12 /2 (C4 / 2)</div-->
    <div data-type="pyth2" data-offset="0" class="noteDiv">&nbsp;0/12 C3 do</div>
    <div data-type="pyth2" data-offset="1" class="halfDiv">&nbsp;1/12 C&#9839;</div><div data-type="pyth2" data-offset="2" class="halfDiv">&nbsp;1/12 D&#9837;</div>
    <div data-type="pyth2" data-offset="3" class="noteDiv refNote">&nbsp;2/12 D ré</div>
    <div data-type="pyth2" data-offset="4" class="halfDiv">&nbsp;3/12 D&#9839;</div><div data-type="pyth2" data-offset="5" class="halfDiv">&nbsp;3/12 E&#9837;</div>
    <div data-type="pyth2" data-offset="6" class="noteDiv">&nbsp;4/12 E mi</div>
    <div data-type="pyth2" data-offset="7" class="noteDiv">&nbsp;5/12 F fa</div>
    <div data-type="pyth2" data-offset="8" class="halfDiv">&nbsp;6/12 F&#9839;</div><div data-type="pyth2" data-offset="9" class="halfDiv">&nbsp;6/12 G&#9837;</div>
    <div data-type="pyth2" data-offset="10" class="noteDiv">&nbsp;7/12 G sol</div>
    <div data-type="pyth2" data-offset="11" class="halfDiv">&nbsp;8/12 G&#9839;</div><div data-type="pyth2" data-offset="12" class="halfDiv">&nbsp;8/12 A&#9837;</div>
    <div data-type="pyth2" data-offset="13" class="noteDiv">&nbsp;9/12 A la</div>
    <div data-type="pyth2" data-offset="14" class="halfDiv">10/12 A&#9839;</div><div data-type="pyth2" data-offset="15" class="halfDiv">10/12 B&#9837;</div>
    <div data-type="pyth2" data-offset="16" class="noteDiv">11/12 B si</div>
    <div data-type="pyth2" data-offset="17" class="noteDiv calcNote">12/12 C4 do</div>
    <!--div data-type="pyth2" data-offset="X" class="noteDiv calcNote">&nbsp;0/12 X 2</div-->

</div>

<div id="pythScale" class="scale">
    Turkish 22 Tones<br>
    &#9839;&#9839;&#9839;&#9839;&#9839;&#9839;&#9839;&#9839;<br>
    D=<input id="freq_tur" type="number" min="1" max="22000" value="293" />(288)<br />
</div>

</body>

</html>
